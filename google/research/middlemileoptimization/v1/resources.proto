// Copyright 2024 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package google.research.middlemileoptimization.v1;

import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/duration.proto";
import "google/research/middlemileoptimization/v1/utils.proto";
import "google/type/datetime.proto";
import "google/type/latlng.proto";

option go_package = "google.golang.org/genproto/googleapis/research/middlemileoptimization/v1;middlemileoptimization";
option java_multiple_files = true;
option java_outer_classname = "ResourcesProto";
option java_package = "com.google.research.middlemileoptimization.v1";

// A pricing strategy.
message PricingStrategy {
  // A pricing strategy.
  oneof pricing_strategy {
    // The pricing strategy is a separable function of several variables.
    SeparableNDFunction separable = 1;
  }
}

// A value along one predefined dimension. The field `value` must be set to the
// corresponding type of the `dimension`.
message ValueDimension {
  // Optional. Value.
  int64 value = 1 [(google.api.field_behavior) = OPTIONAL];

  // Required. Dimension.
  string dimension = 2 [(google.api.field_behavior) = REQUIRED];
}

// Describes the full existing network that can be used.
// A given API customer might have several networks (e.g., the main network and
// a possible future modification to evaluate).
message Network {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/Network"
    pattern: "networks/{network}"
    plural: "networks"
    singular: "network"
  };

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Distance, weight, pallets, etc., plus scaling (to map floats to integers).
  repeated ValueDimension dimensions = 5;

  // Optional. Price to be paid by the sender for shipping a shipment that does
  // not require a dedicated line.
  PricingStrategy pricing = 6 [(google.api.field_behavior) = OPTIONAL];

  // Optional. Single monetary unit used throughout the network. A given API
  // customer can have several different units for different networks; a network
  // is only allowed to have one monetary unit. The unit must be encoded in ISO
  // 4217.
  string currency_code = 7 [(google.api.field_behavior) = OPTIONAL];

  // Optional. Time discretization. Decisions are output with this precision in
  // time. Internally, state is kept with this precision.
  google.protobuf.Duration time_step = 8
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Distance matrix (represented a list of weighted directed edges).
  repeated DistanceMatrixEntry distance_matrix = 9
      [(google.api.field_behavior) = OPTIONAL];
}

// A line that is being operated at a given frequency.
message Line {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/Line"
    pattern: "networks/{network}/lines/{line}"
    plural: "lines"
    singular: "line"
  };

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Required. List of hubs that this line calls at, in the order vehicles stop
  // at them.
  repeated string hub_ids = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];
}

// One rotation of a line that is generated by this API and not the API
// customer. It is inherently less constrained, and could use any vehicle
// (unless the API customer decides otherwise in subsequent calls).
message GeneratedLineAndRotation {
  // Output only. Map between hub IDs and times. This map is supposed to have
  // the same keys (minus the source hub, with no arrival time).
  map<string, google.type.DateTime> arrival_times = 1
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Map between hub IDs and times. This map is supposed to have
  // the same keys (minus the destination hub, with no departure time).
  map<string, google.type.DateTime> departure_times = 2
      [(google.api.field_behavior) = OUTPUT_ONLY];
}

// A vehicle starts operating this line at a particular time.
message LineRotation {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/LineRotation"
    pattern: "networks/{network}/lines/{line}/rotations/{rotation}"
    plural: "lineRotations"
    singular: "lineRotation"
  };

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Optional. Range where departure is allowed without cost (i.e., if not
  // pointwise, the actual arrival times are decided by the system). This map is
  // supposed to have the same keys (minus the source hub, with no arrival
  // time).
  map<string, DateTimeRange> arrival_times = 2
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Range where arrival is allowed without cost (i.e., if not
  // pointwise, the actual departure times are decided by the system). This map
  // is supposed to have the same keys (minus the destination hub, with no
  // departure time).
  map<string, DateTimeRange> departure_times = 3
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Earliness/tardiness costs and bounds for departure. This maps is
  // supposed to have the same keys (minus the destination hub, with no
  // departure time).
  map<string, EarlinessTardiness> departure_earliness_tardiness_costs = 4
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Earliness/tardiness costs and bounds for arrival. This maps is
  // supposed to have the same keys (minus the source hub, with no arrival
  // time).
  map<string, EarlinessTardiness> arrival_earliness_tardiness_costs = 5
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Maximum number of vehicles that can be assigned to this rotation.
  // If unset: no limit in terms of vehicles for this rotation. Otherwise, upper
  // bound on the number of vehicles that can be allocated to this rotation
  // (among the allow list `vehicle_ids`). In particular, a value of 0 disables
  // this rotation (no vehicles allowed).
  optional IntegerRange maximum_number_vehicles = 6
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. List of vehicles that could be doing this line rotation (i.e.
  // allow list). If number_vehicles reduces to one value corresponding to the
  // number of vehicles, all those vehicles will be assigned to the line
  // rotation. If no vehicles, all are considered to be available.
  repeated string vehicles = 7 [
    (google.api.field_behavior) = OPTIONAL,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Vehicle"
    }
  ];

  // Optional. Cost of having *any* vehicle doing this line, regardless of
  // vehicle (driver, maintenance, etc.).
  PricingStrategy fixed_price = 8 [(google.api.field_behavior) = OPTIONAL];
}

// Cost functions due to a shipment arriving/departing sooner or later than
// required (soft constraints).
message EarlinessTardiness {
  // Optional. Maximum allowable earliness. Useful only with costs.
  optional google.protobuf.Duration maximum_earliness = 1
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Maximum allowable tardiness. Useful only with costs.
  optional google.protobuf.Duration maximum_tardiness = 2
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Cost of earliness. Unset iff no cost for earliness.
  optional Function1D earliness_cost = 3
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Cost of tardiness. Unset iff no cost for tardiness.
  optional Function1D tardiness_cost = 4
      [(google.api.field_behavior) = OPTIONAL];
}

// No name, it is stored as a map key within the Network.
message Vehicle {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/Vehicle"
    pattern: "networks/{network}/vehicles/{vehicle}"
    plural: "vehicles"
    singular: "vehicle"
  };

  // Constraint on the position of a vehicle.
  message VehiclePositionConstraint {
    // Time of the constraint.
    google.type.DateTime time = 1;

    // Hub of the constraint.
    string hub_id = 2 [(google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }];
  }

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Optional. Vehicle characteristics.
  repeated ValueDimension capacities = 2
      [(google.api.field_behavior) = OPTIONAL];

  // Required. Cost for using the vehicle. These are functions of one argument:
  // the distance the vehicle travels, the weight the vehicle transports, the
  // number of pallets the vehicle transports. These functions account for
  // maintenance, fuel, and handling costs. These cost may include an upfront
  // cost (paid once the vehicle is used, mostly useful for subcontracting).
  PricingStrategy cost = 3 [(google.api.field_behavior) = REQUIRED];

  // Optional. Price to be paid by the paying party, only if the vehicle is
  // being used in a generated line (i.e. not part of the input network).
  PricingStrategy pricing = 4 [(google.api.field_behavior) = OPTIONAL];

  // Required. Whether this vehicle can be used for generated lines. If set to
  // `false`, the vehicle will be limited to predefined lines where it is
  // allowed.
  bool allowed_for_generated_lines = 5 [(google.api.field_behavior) = REQUIRED];

  // Optional. Forced positions for the current vehicle, along with times. For
  // instance, use entries to model the fact that a vehicle that starts or ends
  // at a given hub.
  repeated VehiclePositionConstraint vehicle_position_constraints = 6
      [(google.api.field_behavior) = OPTIONAL];
}

// Shipments must be brought from one hub to another one.
message Hub {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/Hub"
    pattern: "networks/{network}/hubs/{hub}"
    plural: "hubs"
    singular: "hub"
  };

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Optional. Position to compute real-world paths.
  google.type.LatLng position = 2 [(google.api.field_behavior) = OPTIONAL];

  // Required. Opening times. For now, use a very rough representation: one
  // entry each time the hub opens (if its workers have a lunch break and no one
  // works at that time, there will be two entries for that day).
  repeated DateTimeRange opening_times = 3
      [(google.api.field_behavior) = REQUIRED];

  // Optional. Capacity of the complete hub.
  CrossDockingCapacity cross_docking_capacity = 4
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Time to perform one cross-docking operation (per vehicle).
  CrossDockingTime cross_docking_time = 5
      [(google.api.field_behavior) = OPTIONAL];
}

// Overall cross-docking capacity for a hub.
message CrossDockingCapacity {
  // Optional. Cross-docking capacity for each dimension.
  repeated ValueDimension capacity_per_hour = 1
      [(google.api.field_behavior) = OPTIONAL];
}

// Overall cross-docking time for a hub.
message CrossDockingTime {
  // Optional. Constant time for a cross-docking operation.
  google.protobuf.Duration time_constant = 1
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Separability is a simplifying assumption.
  SeparableNDFunction time = 2 [(google.api.field_behavior) = OPTIONAL];
}

// Distance between a source hub and a destination hub.
message DistanceMatrixEntry {
  // Required. Source hub.
  string source_hub = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Destination hub.
  string destination_hub = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Distance between the hubs, measured in several dimensions.
  repeated ValueDimension weights = 3 [(google.api.field_behavior) = REQUIRED];
}

// Shipment to perform.
message Shipment {
  option (google.api.resource) = {
    type: "middlemileoptimization.googleapis.com/Shipment"
    pattern: "networks/{network}/shipments/{shipment}"
    plural: "shipments"
    singular: "shipment"
  };

  // Required. Identifier. Cannot be updated.
  string name = 1 [(google.api.field_behavior) = IDENTIFIER];

  // Required. Hub at which the shipment is made available.
  string source_hub = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Hub to which the shipment must be delivered.
  string destination_hub = 3 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Departure time.
  google.type.DateTime departure_time = 4
      [(google.api.field_behavior) = REQUIRED];

  // Required. *Expected* arrival time (i.e. soft constraint).
  DateTimeRange arrival_time = 5 [(google.api.field_behavior) = REQUIRED];

  // Optional. SLAs indicate that this time may be exceeded with some penalty.
  // (If later than the maximum, the package is no more useful.)
  // The penalty is given by a function of the delay (in minutes).
  EarlinessTardiness arrival_earliness_tardiness_cost = 6
      [(google.api.field_behavior) = OPTIONAL];

  // Optional. Revenue from this package (only used to compute the reward), i.e.
  // price paid by the paying party. If unset, revenue is computed by the system
  // (depending on whether a new line is generated for this shipment or not).
  optional double revenue = 7 [(google.api.field_behavior) = OPTIONAL];

  // Optional. Used with vehicle and hub capacities.
  repeated ValueDimension size = 8 [(google.api.field_behavior) = OPTIONAL];
}

// Path for a shipment within the network.
message Path {
  // Required. Shipment whose path is being described.
  string shipment = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Shipment"
    }
  ];

  // Required. Segments of the path.
  repeated AnnotatedPathSegment segments = 2
      [(google.api.field_behavior) = REQUIRED];

  // Output only. Actual departure time of the shipment.
  google.type.DateTime departure_time = 3
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Actual arrival time of the shipment.
  google.type.DateTime arrival_time = 4
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Penalties due to soft constraints not respected.
  double incurred_penalties = 5 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Constant cost for this shipment.
  double cost_constant = 6 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Cost by components.
  map<string, double> cost = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Represents a part of a path, either sent by the API customer to the API
// server (e.g., state change) or by the API server to the API customer (e.g.,
// routing a shipment).
message PathSegment {
  // Required. Source of the segment.
  string source_hub = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Destination of the segment.
  string destination_hub = 2 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Hub"
    }
  ];

  // Required. Line being followed for this segment.
  string line = 3 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Line"
    }
  ];

  // Required. Rotation being followed for this segment.
  string line_rotation = 4 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/LineRotation"
    }
  ];

  // Required. Vehicle followed by this segment.
  string vehicle = 5 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {
      type: "middlemileoptimization.googleapis.com/Vehicle"
    }
  ];
}

// Represents a part of a path with more redundant information that can be
// computed based on the contained PathSegment and the Network.
// These messages are typically returned by the API server.
message AnnotatedPathSegment {
  // Required. Segment being annotated.
  PathSegment segment = 1 [(google.api.field_behavior) = REQUIRED];

  // Output only. Arrival time of this segment.
  google.type.DateTime arrival_time = 2
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Departure time of this segment.
  google.type.DateTime departure_time = 3
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Whether the API customer has decided to commit this part of
  // the path.
  bool is_committed = 4 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Constant cost for this segment.
  double segment_cost_constant = 5 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. One entry per dimension.
  map<string, double> segment_cost_due_to_vehicle = 6
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Cost due to the line rotation: departure.
  double segment_cost_due_to_departure = 7
      [(google.api.field_behavior) = OUTPUT_ONLY];

  // Output only. Cost due to the line rotation: arrival.
  double segment_cost_due_to_arrival = 8
      [(google.api.field_behavior) = OUTPUT_ONLY];
}
